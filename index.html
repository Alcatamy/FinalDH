<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Divisi√≥n de Honor - Calculadora Detallada</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .champion-banner {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            z-index: 1000;
            font-size: 1.2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .header {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .logos {
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            flex-wrap: wrap;
            gap: 20px;
        }

        .team-logo {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .team-logo img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            margin-bottom: 10px;
            border-radius: 50%; 
            background-color: #fff; 
            padding: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .team-logo h3 {
            font-size: 1.1rem;
            color: #333;
            max-width: 150px;
        }

        .vs {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .results-section {
            padding: 30px;
        }

        .ida-results, .vuelta-results {
            background: #eef7ee; 
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            border: 1px solid #d4e8d4;
        }

        .ida-results h3, .vuelta-results h3 {
            color: #155724; 
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #28a745;
            padding-bottom: 5px;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .summary-table th, .summary-table td {
            padding: 12px; 
            text-align: center;
            border: 1px solid #c8e6c9; 
        }

        .summary-table th {
            background: #28a745;
            color: white;
            font-weight: 600; 
        }
        .summary-table tbody tr:nth-child(even) {
            background-color: #f8f9fa; 
        }


        .final-summary {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #ced4da;
        }
         .final-summary h3 {
            color: #004085; 
            margin-bottom: 15px;
            font-size: 1.3rem;
            border-bottom: 2px solid #007bff;
            padding-bottom: 5px;
        }


        .vuelta-section {
            background: #fff9e6; 
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #ffecb3;
        }

        .vuelta-section h3 {
            color: #856404; 
            margin-bottom: 20px;
            font-size: 1.4rem; 
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            border-bottom: 2px solid #ffc107; 
            padding-bottom: 10px;
        }

        .vuelta-title-logos {
            display: flex;
            align-items: center;
            gap: 10px; 
        }

        .vuelta-title-logos img {
            width: 35px; 
            height: 35px;
            object-fit: contain;
            border-radius: 50%;
        }

        .partido {
            background: white;
            border: 1px solid #ddd; 
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .partido:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }


        .partido.finalizado {
        }

        .partido.winner-recreativo {
            border-left: 5px solid #28a745; 
            background: linear-gradient(135deg, #f0fff0, #e6ffe6); 
        }

        .partido.winner-cartagena {
            border-left: 5px solid #007bff;
            background: linear-gradient(135deg, #e6f7ff, #d9f0ff);
        }

        .winner-label {
            position: absolute;
            top: 10px;
            right: 15px; 
            background: #ffd700;
            color: #333;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: bold;
            animation: bounceIn 0.5s ease-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        @keyframes bounceIn {
            0% { transform: scale(0.5); opacity: 0; }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }


        .partido-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .partido-nombre {
            font-weight: bold;
            font-size: 1.15rem; 
            color: #333;
            margin-right: auto; 
        }
        .marcador {
            font-size: 1.1rem;
            font-weight: bold;
            background-color: #f0f0f0;
            padding: 5px 10px;
            border-radius: 5px;
            margin-left: 10px; 
        }


        .partido-content {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 15px;
            align-items: start;
        }

        .equipos-labels {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-top: 5px;
        }

        .equipo-label {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            height: 40px;
            font-weight: bold;
            font-size: 0.95rem;
            padding-right: 8px;
        }

        .equipo-label.cartagena { color: #007bff; }
        .equipo-label.recreativo { color: #28a745; }


        .sets-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(85px, 1fr)); 
            gap: 10px; 
            max-width: 100%;
        }

        .set {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px; 
            text-align: center;
            min-height: 100px;
            border: 1px solid #e9ecef;
        }
        .set strong {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #555;
        }

        .set-inputs {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
        }

        .set-input {
            width: 55px; 
            height: 40px;
            text-align: center;
            border: 1px solid #ced4da; 
            border-radius: 5px;
            font-size: 1rem;
            font-weight: bold;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .set-input::placeholder {
            color: #bbb;
            font-weight: normal;
        }

        .set-input:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        .champion-section {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            border: 3px solid #ffb800;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin: 30px 0; 
            display: none;
            animation: fadeInScale 0.8s ease-out;
            box-shadow: 0 10px 30px rgba(255,215,0,0.3);
        }
        @keyframes fadeInScale {
            from { transform: scale(0.8) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }


        .champion-section.show { display: block; }

        .champion-section h2 {
            font-size: 2.8rem; 
            color: #333;
            margin-bottom: 20px;
            animation: championTextAnim 1.5s infinite ease-in-out;
        }
        @keyframes championTextAnim {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .champion-section .trophy {
            font-size: 4.5rem; 
            color: #8c6d00; 
            margin-bottom: 20px;
            animation: trophyRotate 3s linear infinite;
        }
         @keyframes trophyRotate {
            0% { transform: rotateY(0deg) scale(1); }
            50% { transform: rotateY(180deg) scale(1.1); }
            100% { transform: rotateY(360deg) scale(1); }
        }
        .champion-section p {
            font-size: 1.1rem;
            color: #555;
        }


        .scenario-section {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 10px;
            margin: 30px 0; 
        }

        .scenario-toggle {
            background: #007bff;
            color: white;
            padding: 15px 20px;
            border: none;
            border-radius: 10px; 
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 1.2rem; 
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.3s;
        }
        .scenario-toggle:hover {
            background-color: #0056b3;
        }
        .scenario-toggle.open {
             border-radius: 10px 10px 0 0; 
        }
        .scenario-toggle .fas {
             transition: transform 0.3s ease-in-out;
        }


        .scenario-content {
            padding: 20px;
            display: none;
            border-top: 1px solid #ddd;
        }

        .scenario-content.show { display: block; }
        .scenario-content hr {
            margin: 15px 0;
            border: 0;
            border-top: 1px solid #eee;
        }
        .scenario-content h4 {
            margin-bottom: 10px;
            color: #333;
            font-size: 1.1rem;
        }


        .scenario-item {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .scenario-item h5 {
            color: #007bff;
            margin-bottom: 10px;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .scenario-item.recreativo h5 { color: #28a745; }


        .min-requirements {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 12px 15px; 
            margin-top: 10px;
            border-radius: 0 5px 5px 0;
            font-size: 0.95rem;
        }
        .min-requirements p { margin: 8px 0; line-height: 1.6; } 
        .min-requirements ul { margin-left: 20px; margin-top: 5px; margin-bottom: 5px; }
        .min-requirements li { margin-bottom: 3px; }
        .min-requirements.recreativo { border-left-color: #28a745; }


        @media (max-width: 768px) {
            .header h1 { font-size: 2rem; }
            .header .subtitle { font-size: 1.1rem; }
            .team-logo img { width: 60px; height: 60px; }
            .vs { font-size: 1.5rem; }
            .partido-content { grid-template-columns: 110px 1fr; gap: 10px; }
            .equipos-labels { gap: 8px; }
            .equipo-label { height: 35px; font-size: 0.85rem; }
            .champion-section h2 { font-size: 2.2rem; }
            .sets-container { grid-template-columns: repeat(auto-fit, minmax(75px, 1fr)); }
            .set-input { width: 50px; height: 38px; }
        }

        @media (max-width: 480px) {
            body { padding: 10px; }
            .container { margin: 0; border-radius: 10px;}
            .header, .results-section, .vuelta-section { padding: 15px; }
            .logos { padding: 15px; }
            .partido-content { grid-template-columns: 1fr; gap: 15px; }
            .equipos-labels { flex-direction: row; justify-content: space-around; gap: 10px; margin-bottom:10px }
            .equipo-label { justify-content: center; padding-right: 0; height: auto; }
            .partido-header { flex-direction: column; align-items: flex-start; gap: 5px; }
            .marcador { align-self: flex-start; }
            .vuelta-section h3 { font-size: 1.2rem; }
            .scenario-toggle { font-size: 1rem; }
            .winner-label { font-size: 0.75rem; padding: 4px 8px; }
        }
    </style>
</head>
<body>
    <div id="championBanner" class="champion-banner">
        <i class="fas fa-trophy"></i> ¬°CAMPE√ìN MATEM√ÅTICO DETERMINADO!
    </div>

    <div class="container">
        <div class="header">
            <h1><i class="fas fa-medal"></i> Final Divisi√≥n de Honor</h1>
            <p class="subtitle">Calculadora de Escenarios - Liga Nacional de Clubes de B√°dminton</p>
        </div>

        <div class="logos">
            <div class="team-logo">
                <img src="https://liga.badminton.es/wp-content/uploads/2022/12/Logo-Puertas-Padilla-Cartagena.png" alt="[Logo de Puertas Padilla Cartagena]" onerror="this.alt='Logo Cartagena'; this.src='https://placehold.co/80x80/007bff/ffffff?text=CAR';">
                <h3>Puertas Padilla Cartagena</h3>
            </div>
            <div class="vs">VS</div>
            <div class="team-logo">
                <img src="https://liga.badminton.es/wp-content/uploads/2022/09/IES-La-Orden.png" alt="[Logo de Recreativo IES La Orden]" onerror="this.alt='Logo IES La Orden'; this.src='https://placehold.co/80x80/28a745/ffffff?text=IES';">
                <h3>Recreativo IES La Orden</h3>
            </div>
        </div>

        <div class="results-section">
            <div class="ida-results">
                <h3><i class="fas fa-calendar-alt"></i> Resultados Final-IDA</h3>
                <table class="summary-table">
                    <thead>
                        <tr>
                            <th>Equipo</th>
                            <th>Partidos Ganados</th>
                            <th>Sets Ganados</th>
                            <th>Puntos Ganados</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Recreativo IES La Orden</strong></td>
                            <td id="ida-rec-pg">4</td>
                            <td id="ida-rec-sg">14</td>
                            <td id="ida-rec-ptg">225</td>
                        </tr>
                        <tr>
                            <td><strong>Puertas Padilla Cartagena</strong></td>
                            <td id="ida-car-pg">3</td>
                            <td id="ida-car-sg">10</td>
                            <td id="ida-car-ptg">200</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="vuelta-results">
                <h3><i class="fas fa-sync-alt"></i> Resultados Parciales Final-VUELTA</h3>
                <table class="summary-table" id="vueltaSummary">
                    <thead>
                        <tr>
                            <th>Equipo</th>
                            <th>Partidos Ganados</th>
                            <th>Sets Ganados</th>
                            <th>Puntos Ganados</th>
                        </tr>
                    </thead>
                    <tbody id="vueltaSummaryBody">
                        </tbody>
                </table>
            </div>

            <div class="final-summary">
                <h3><i class="fas fa-poll"></i> Acumulado General (Ida + Vuelta)</h3>
                <table class="summary-table" id="finalSummary">
                    <thead>
                        <tr>
                            <th>Equipo</th>
                            <th>Partidos Ganados</th>
                            <th>Sets Ganados</th>
                            <th>Puntos Ganados</th>
                        </tr>
                    </thead>
                    <tbody id="finalSummaryBody">
                        </tbody>
                </table>
            </div>

            <div id="championSection" class="champion-section">
                <div class="trophy"><i class="fas fa-trophy"></i></div>
                <h2 id="championName">¬°CAMPE√ìN!</h2>
                <p id="championDetails"></p>
            </div>

            <div class="vuelta-section">
                <h3>
                    <i class="fas fa-keyboard"></i>
                    <span>Introducir Resultados Partido de Vuelta:</span>
                    <div class="vuelta-title-logos">
                        <img src="https://liga.badminton.es/wp-content/uploads/2022/12/Logo-Puertas-Padilla-Cartagena.png" alt="[Logo de Puertas Padilla Cartagena]" onerror="this.alt='Logo Cartagena'; this.src='https://placehold.co/80x80/007bff/ffffff?text=CAR';">
                        <span>vs</span>
                        <img src="https://liga.badminton.es/wp-content/uploads/2022/09/IES-La-Orden.png" alt="[Logo de Recreativo IES La Orden]" onerror="this.alt='Logo IES La Orden'; this.src='https://placehold.co/80x80/28a745/ffffff?text=IES';">
                    </div>
                </h3>
                <div id="partidosContainer">
                    </div>
            </div>

            <div class="scenario-section">
                <button class="scenario-toggle" onclick="toggleScenarios()">
                    <span><i class="fas fa-calculator"></i> Escenarios Detallados para ser Campe√≥n</span>
                    <i class="fas fa-chevron-down" id="scenarioIcon"></i>
                </button>
                <div id="scenarioContent" class="scenario-content">
                    <div id="scenarioText"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const resultadosIda = {
            recreativo: { partidos: 4, sets: 14, puntos: 225 },
            cartagena: { partidos: 3, sets: 10, puntos: 200 }
        };

        let partidosVuelta = {
            'DX': { setsData: [], setsRecreativo: 0, setsCartagena: 0, puntosRecreativo: 0, puntosCartagena: 0, finalizado: false, ganador: null },
            'DF': { setsData: [], setsRecreativo: 0, setsCartagena: 0, puntosRecreativo: 0, puntosCartagena: 0, finalizado: false, ganador: null },
            'DM': { setsData: [], setsRecreativo: 0, setsCartagena: 0, puntosRecreativo: 0, puntosCartagena: 0, finalizado: false, ganador: null },
            'IF2': { setsData: [], setsRecreativo: 0, setsCartagena: 0, puntosRecreativo: 0, puntosCartagena: 0, finalizado: false, ganador: null },
            'IM2': { setsData: [], setsRecreativo: 0, setsCartagena: 0, puntosRecreativo: 0, puntosCartagena: 0, finalizado: false, ganador: null },
            'IF1': { setsData: [], setsRecreativo: 0, setsCartagena: 0, puntosRecreativo: 0, puntosCartagena: 0, finalizado: false, ganador: null },
            'IM1': { setsData: [], setsRecreativo: 0, setsCartagena: 0, puntosRecreativo: 0, puntosCartagena: 0, finalizado: false, ganador: null }
        };

        const nombresPartidos = {
            'DX': 'Dobles Mixto', 'DF': 'Dobles Femenino', 'DM': 'Dobles Masculino',
            'IF2': 'Individual Femenino 2', 'IM2': 'Individual Masculino 2',
            'IF1': 'Individual Femenino 1', 'IM1': 'Individual Masculino 1'
        };
        const ordenPartidos = ['DX', 'DF', 'DM', 'IF2', 'IM2', 'IF1', 'IM1'];
        const NOMBRE_IES_LA_ORDEN = "IES La Orden"; 
        const NOMBRE_CARTAGENA = "Puertas Padilla Cartagena";

        // --- Funciones auxiliares para nombres y plurales ---
        function nombreEquipoKey(key) { return key === 'recreativo' ? NOMBRE_IES_LA_ORDEN : NOMBRE_CARTAGENA; }
        function pluralTxt(num, palabraSingular, palabraPluralOpcional) {
            if (num === 1) return palabraSingular;
            return palabraPluralOpcional || palabraSingular + "s";
        }

        function inicializarPartidosUI() {
            const container = document.getElementById('partidosContainer');
            container.innerHTML = ''; 
            ordenPartidos.forEach(partidoId => {
                const partidoDiv = document.createElement('div');
                partidoDiv.className = 'partido';
                partidoDiv.id = `partido-${partidoId}`;
                partidoDiv.innerHTML = `
                    <div class="partido-header">
                        <div class="partido-nombre">${nombresPartidos[partidoId]} (${partidoId})</div>
                        <div class="marcador" id="marcador-${partidoId}">CAR 0 - 0 LAO</div>
                    </div>
                    <div class="partido-content">
                        <div class="equipos-labels">
                            <div class="equipo-label cartagena">Cartagena:</div>
                            <div class="equipo-label recreativo">IES La Orden:</div>
                        </div>
                        <div class="sets-container" id="sets-${partidoId}">
                            ${crearSetUI(partidoId, 0)}
                        </div>
                    </div>`;
                container.appendChild(partidoDiv);
            });
        }

        function crearSetUI(partidoId, setIndex) {
            if (!partidosVuelta[partidoId].setsData[setIndex]) {
                 partidosVuelta[partidoId].setsData[setIndex] = { car: '', rec: '' };
            }
            const setData = partidosVuelta[partidoId].setsData[setIndex];
            return `
                <div class="set" id="set-${partidoId}-${setIndex}">
                    <div><strong>Set ${setIndex + 1}</strong></div>
                    <div class="set-inputs">
                        <input type="number" class="set-input" id="input-${partidoId}-${setIndex}-car" 
                               min="0" max="30" placeholder="0" value="${setData.car}"
                               oninput="actualizarSet('${partidoId}', ${setIndex}, 'car', this.value)">
                        <input type="number" class="set-input" id="input-${partidoId}-${setIndex}-rec" 
                               min="0" max="30" placeholder="0" value="${setData.rec}"
                               oninput="actualizarSet('${partidoId}', ${setIndex}, 'rec', this.value)">
                    </div>
                </div>`;
        }
        
        function actualizarSet(partidoId, setIndex, equipoModificado, valorStr) {
            const partido = partidosVuelta[partidoId];
            if (equipoModificado === 'car') partido.setsData[setIndex].car = valorStr; 
            else partido.setsData[setIndex].rec = valorStr;

            const inputCar = document.getElementById(`input-${partidoId}-${setIndex}-car`);
            const inputRec = document.getElementById(`input-${partidoId}-${setIndex}-rec`);
            const valorNumModificado = parseInt(valorStr);

            if (!isNaN(valorNumModificado) && valorNumModificado < 11 && valorNumModificado >= 0) {
                if (equipoModificado === 'car') { 
                    if (inputRec.value === '' || parseInt(inputRec.value) === 0) {
                        inputRec.value = '11'; partido.setsData[setIndex].rec = '11'; 
                    }
                } else { 
                     if (inputCar.value === '' || parseInt(inputCar.value) === 0) {
                        inputCar.value = '11'; partido.setsData[setIndex].car = '11'; 
                    }
                }
            }
            recalcularPartido(partidoId); 
            actualizarResumenVuelta();
            actualizarResumenFinal();
            verificarCampeonMatematicoGlobal(); 
        }

        function recalcularPartido(partidoId) {
            const partido = partidosVuelta[partidoId];
            partido.setsRecreativo = 0; partido.setsCartagena = 0;
            partido.puntosRecreativo = 0; partido.puntosCartagena = 0;
            partido.finalizado = false; partido.ganador = null;
            let setsValidosParaNuevoUI = 0;

            for (let i = 0; i < partido.setsData.length; i++) {
                const set = partido.setsData[i];
                const puntosCar = set.car === '' ? NaN : parseInt(set.car);
                const puntosRec = set.rec === '' ? NaN : parseInt(set.rec);

                if (!isNaN(puntosCar)) partido.puntosCartagena += puntosCar;
                if (!isNaN(puntosRec)) partido.puntosRecreativo += puntosRec;
                let setTerminadoEsteLoop = false;
                if (!isNaN(puntosCar) && !isNaN(puntosRec)) { 
                    if (puntosCar >= 11 && puntosCar > puntosRec) { partido.setsCartagena++; setTerminadoEsteLoop = true; }
                    else if (puntosRec >= 11 && puntosRec > puntosCar) { partido.setsRecreativo++; setTerminadoEsteLoop = true; }
                }
                if(setTerminadoEsteLoop) setsValidosParaNuevoUI++;
                if (partido.setsCartagena === 3 || partido.setsRecreativo === 3) {
                    partido.finalizado = true;
                    partido.ganador = partido.setsCartagena === 3 ? 'cartagena' : 'recreativo';
                    break; 
                }
            }
            
            const partidoElement = document.getElementById(`partido-${partidoId}`);
            document.getElementById(`marcador-${partidoId}`).textContent = `CAR ${partido.setsCartagena} - ${partido.setsRecreativo} LAO`;
            partidoElement.classList.remove('winner-recreativo', 'winner-cartagena', 'finalizado');
            const existingWinnerLabel = partidoElement.querySelector('.winner-label');
            if (existingWinnerLabel) existingWinnerLabel.remove();

            if (partido.finalizado) {
                partidoElement.classList.add('finalizado');
                const winnerClass = partido.ganador === 'recreativo' ? 'winner-recreativo' : 'winner-cartagena';
                const winnerName = partido.ganador === 'recreativo' ? NOMBRE_IES_LA_ORDEN : NOMBRE_CARTAGENA;
                partidoElement.classList.add(winnerClass);
                const winnerLabel = document.createElement('div');
                winnerLabel.className = 'winner-label';
                winnerLabel.innerHTML = `<i class="fas fa-crown"></i> Gana ${winnerName}`;
                partidoElement.appendChild(winnerLabel);
            }

            const setsContainer = document.getElementById(`sets-${partidoId}`);
            const numCurrentSetDivs = setsContainer.children.length;
            const maxSetsPorPartido = 5; 
            if (!partido.finalizado && setsValidosParaNuevoUI === numCurrentSetDivs && numCurrentSetDivs < maxSetsPorPartido) {
                const ultimoSetData = partido.setsData[numCurrentSetDivs -1];
                 if(ultimoSetData && !isNaN(parseInt(ultimoSetData.car)) && !isNaN(parseInt(ultimoSetData.rec))){ 
                    if ((parseInt(ultimoSetData.car) >= 11 && parseInt(ultimoSetData.car) > parseInt(ultimoSetData.rec)) || (parseInt(ultimoSetData.rec) >= 11 && parseInt(ultimoSetData.rec) > parseInt(ultimoSetData.car))) {
                         setsContainer.insertAdjacentHTML('beforeend', crearSetUI(partidoId, numCurrentSetDivs));
                    }
                 }
            }
        }
        
        function calcularResultadosVuelta() {
            let res = { recreativo: { partidos: 0, sets: 0, puntos: 0 }, cartagena: { partidos: 0, sets: 0, puntos: 0 } };
            Object.values(partidosVuelta).forEach(partido => {
                if (partido.finalizado) {
                    if (partido.ganador === 'recreativo') res.recreativo.partidos++;
                    else if (partido.ganador === 'cartagena') res.cartagena.partidos++;
                }
                res.recreativo.sets += partido.setsRecreativo; res.cartagena.sets += partido.setsCartagena;
                res.recreativo.puntos += partido.puntosRecreativo; res.cartagena.puntos += partido.puntosCartagena;
            });
            return res;
        }

        function calcularResultadosFinalGlobales() {
            const resVuelta = calcularResultadosVuelta();
            return {
                recreativo: { 
                    partidos: resultadosIda.recreativo.partidos + resVuelta.recreativo.partidos,
                    sets: resultadosIda.recreativo.sets + resVuelta.recreativo.sets,
                    puntos: resultadosIda.recreativo.puntos + resVuelta.recreativo.puntos
                },
                cartagena: {
                    partidos: resultadosIda.cartagena.partidos + resVuelta.cartagena.partidos,
                    sets: resultadosIda.cartagena.sets + resVuelta.cartagena.sets,
                    puntos: resultadosIda.cartagena.puntos + resVuelta.cartagena.puntos
                }
            };
        }

        function actualizarResumenVuelta() {
            const resultados = calcularResultadosVuelta();
            document.getElementById('vueltaSummaryBody').innerHTML = `
                <tr><td><strong>${NOMBRE_IES_LA_ORDEN}</strong></td><td>${resultados.recreativo.partidos}</td><td>${resultados.recreativo.sets}</td><td>${resultados.recreativo.puntos}</td></tr>
                <tr><td><strong>${NOMBRE_CARTAGENA}</strong></td><td>${resultados.cartagena.partidos}</td><td>${resultados.cartagena.sets}</td><td>${resultados.cartagena.puntos}</td></tr>`;
        }

        function actualizarResumenFinal() {
            const resultados = calcularResultadosFinalGlobales();
            const rec = resultados.recreativo; const car = resultados.cartagena;
            let primero = rec, segundo = car, nombrePrimero = NOMBRE_IES_LA_ORDEN, nombreSegundo = NOMBRE_CARTAGENA;
            const resComp = determinarCampeonConResultadosProyectados(rec, car);
            if (resComp.campeon === NOMBRE_CARTAGENA) { 
                 [primero, segundo] = [car, rec]; [nombrePrimero, nombreSegundo] = [NOMBRE_CARTAGENA, NOMBRE_IES_LA_ORDEN];
            } 
            document.getElementById('finalSummaryBody').innerHTML = `
                <tr><td><strong>${nombrePrimero}</strong></td><td>${primero.partidos}</td><td>${primero.sets}</td><td>${primero.puntos}</td></tr>
                <tr><td><strong>${nombreSegundo}</strong></td><td>${segundo.partidos}</td><td>${segundo.sets}</td><td>${segundo.puntos}</td></tr>`;
        }
        
        function verificarCampeonMatematicoGlobal() {
            const resultadosGlobales = calcularResultadosFinalGlobales();
            const partidosFinalizadosVuelta = Object.values(partidosVuelta).filter(p => p.finalizado).length;
            const partidosRestantesEnVuelta = ordenPartidos.length - partidosFinalizadosVuelta;
            let campeonFinal = null, razonFinal = "";     
            const SETS_MAX_POR_PARTIDO_GANADO = 3; 

            const recP = resultadosGlobales.recreativo.partidos, recS = resultadosGlobales.recreativo.sets;
            const carP = resultadosGlobales.cartagena.partidos, carS = resultadosGlobales.cartagena.sets;

            if (partidosRestantesEnVuelta > 0) {
                if (recP > carP + partidosRestantesEnVuelta) {
                    campeonFinal = NOMBRE_IES_LA_ORDEN;
                    razonFinal = `Matem√°ticamente campe√≥n por partidos. ${NOMBRE_CARTAGENA} (actualmente ${carP}p) no puede alcanzar los ${recP} partidos de ${NOMBRE_IES_LA_ORDEN} (m√°x. ${carP + partidosRestantesEnVuelta}p).`;
                } else if (carP > recP + partidosRestantesEnVuelta) {
                    campeonFinal = NOMBRE_CARTAGENA;
                    razonFinal = `Matem√°ticamente campe√≥n por partidos. ${NOMBRE_IES_LA_ORDEN} (actualmente ${recP}p) no puede alcanzar los ${carP} partidos de ${NOMBRE_CARTAGENA} (m√°x. ${recP + partidosRestantesEnVuelta}p).`;
                } else {
                    const recS_siGanaTodo3a0 = recS + (partidosRestantesEnVuelta * SETS_MAX_POR_PARTIDO_GANADO);
                    const carS_siGanaTodo3a0 = carS + (partidosRestantesEnVuelta * SETS_MAX_POR_PARTIDO_GANADO);
                    if (recS > carS_siGanaTodo3a0) { 
                        campeonFinal = NOMBRE_IES_LA_ORDEN;
                        razonFinal = `Matem√°ticamente campe√≥n por sets. ${NOMBRE_IES_LA_ORDEN} (${recS}s) tiene m√°s sets que el m√°ximo posible para ${NOMBRE_CARTAGENA} (${carS_siGanaTodo3a0}s) incluso si Cartagena gana los ${partidosRestantesEnVuelta} partidos restantes 3-0.`;
                    } else if (carS > recS_siGanaTodo3a0) { 
                        campeonFinal = NOMBRE_CARTAGENA;
                        razonFinal = `Matem√°ticamente campe√≥n por sets. ${NOMBRE_CARTAGENA} (${carS}s) tiene m√°s sets que el m√°ximo posible para ${NOMBRE_IES_LA_ORDEN} (${recS_siGanaTodo3a0}s) incluso si IES La Orden gana los ${partidosRestantesEnVuelta} partidos restantes 3-0.`;
                    }
                }
            }
            
            if (!campeonFinal && partidosRestantesEnVuelta === 0) {
                const resDesempateFinal = determinarCampeonConResultadosProyectados(resultadosGlobales.recreativo, resultadosGlobales.cartagena);
                campeonFinal = resDesempateFinal.campeon; razonFinal = resDesempateFinal.razon;
            }

            const championBanner = document.getElementById('championBanner');
            const championSection = document.getElementById('championSection');
            const championNameEl = document.getElementById('championName');
            const championDetailsEl = document.getElementById('championDetails');

            if (campeonFinal && campeonFinal !== 'Empate T√©cnico Absoluto') {
                const esMatematico = (partidosRestantesEnVuelta > 0 && razonFinal.toLowerCase().includes("matem√°ticamente"));
                const tipoMsg = esMatematico ? "CAMPE√ìN MATEM√ÅTICO" : "CAMPE√ìN";
                championNameEl.textContent = `¬°${campeonFinal} ${tipoMsg}!`;
                championDetailsEl.textContent = razonFinal;
                championSection.classList.add('show');
                championBanner.innerHTML = `<i class="fas fa-trophy"></i> ¬°${tipoMsg}: ${campeonFinal}!`;
                championBanner.style.display = 'block';
                if (partidosRestantesEnVuelta === 0 && !esMatematico) setTimeout(() => { window.scrollTo({ top: 0, behavior: 'smooth' }); }, 100);
            } else if (campeonFinal === 'Empate T√©cnico Absoluto') {
                championNameEl.textContent = `¬°EMPATE T√âCNICO!`;
                championDetailsEl.textContent = razonFinal;
                championSection.classList.add('show');
                championBanner.innerHTML = `<i class="fas fa-handshake"></i> ¬°EMPATE T√âCNICO ABSOLUTO!`;
                championBanner.style.display = 'block';
            } else { 
                championSection.classList.remove('show');
                championBanner.style.display = 'none';
            }
            actualizarEscenarios(); 
        }
        
        function determinarCampeonConResultadosProyectados(proyRec, proyCar) {
            if (proyRec.partidos > proyCar.partidos) return { campeon: NOMBRE_IES_LA_ORDEN, razon: `por partidos (${proyRec.partidos}-${proyCar.partidos}).` };
            if (proyCar.partidos > proyRec.partidos) return { campeon: NOMBRE_CARTAGENA, razon: `por partidos (${proyCar.partidos}-${proyRec.partidos}).` };
            if (proyRec.sets > proyCar.sets) return { campeon: NOMBRE_IES_LA_ORDEN, razon: `tras empatar a ${proyRec.partidos} partidos, gana por sets (${proyRec.sets}-${proyCar.sets}).` };
            if (proyCar.sets > proyRec.sets) return { campeon: NOMBRE_CARTAGENA, razon: `tras empatar a ${proyRec.partidos} partidos, gana por sets (${proyCar.sets}-${proyRec.sets}).` };
            if (proyRec.puntos > proyCar.puntos) return { campeon: NOMBRE_IES_LA_ORDEN, razon: `tras empatar en partidos (${proyRec.partidos}) y sets (${proyRec.sets}), gana por puntos (${proyRec.puntos}-${proyCar.puntos}).` };
            if (proyCar.puntos > proyRec.puntos) return { campeon: NOMBRE_CARTAGENA, razon: `tras empatar en partidos (${proyRec.partidos}) y sets (${proyRec.sets}), gana por puntos (${proyCar.puntos}-${proyRec.puntos}).` };
            return { campeon: 'Empate T√©cnico Absoluto', razon: `empate en partidos (${proyRec.partidos}), sets (${proyRec.sets}) y puntos (${proyRec.puntos}).` };
        }

        function esMejorEscenario(nuevo, actual) {
            if (actual === null) return true;
            if (nuevo.partidosAGanarIdealmente3a0 < actual.partidosAGanarIdealmente3a0) return true;
            if (nuevo.partidosAGanarIdealmente3a0 > actual.partidosAGanarIdealmente3a0) return false;
            if (nuevo.tipo === 'partidos' && actual.tipo === 'sets') return true; // Partido directo mejor que set si mismos partidos a ganar
            if (nuevo.tipo === 'sets' && actual.tipo === 'partidos') return false;
            if (nuevo.setsAdicionalesEnDerrotas < actual.setsAdicionalesEnDerrotas) return true; // Menos sets adicionales es mejor
            if (nuevo.setsAdicionalesEnDerrotas > actual.setsAdicionalesEnDerrotas) return false;
            return false; 
        }

        function calcularEscenarioCampeonMatematicoRapido(equipoConsideradoKey, resultadosGlobales, partidosRestantesVuelta) {
            const oponenteConsideradoKey = equipoConsideradoKey === 'recreativo' ? 'cartagena' : 'recreativo';
            const statsEquipoActual = resultadosGlobales[equipoConsideradoKey];
            const statsOponenteActual = resultadosGlobales[oponenteConsideradoKey];
            let escenarioOptimo = null;

            // Escenario 1: Campe√≥n matem√°tico por SETS "jugando lo m√≠nimo"
            for (let pGanadosEquipo3a0 = 0; pGanadosEquipo3a0 <= partidosRestantesVuelta; pGanadosEquipo3a0++) {
                const setsObtenidosEquipoConVictorias = statsEquipoActual.sets + (pGanadosEquipo3a0 * 3);
                const setsOponenteConVictoriasEquipo = statsOponenteActual.sets;
                const partidosRestantesPostVictoriasEquipo = partidosRestantesVuelta - pGanadosEquipo3a0;
                const setsMaxOponenteSiGanaResto3a0 = setsOponenteConVictoriasEquipo + (partidosRestantesPostVictoriasEquipo * 3);
                const setsEquipoSiPierdeResto0a3 = setsObtenidosEquipoConVictorias;

                if (setsEquipoSiPierdeResto0a3 > setsMaxOponenteSiGanaResto3a0) { // Caso A: Campe√≥n por sets sin necesitar sets adicionales
                    const detalle = `Ganando ${pGanadosEquipo3a0} ${pluralTxt(pGanadosEquipo3a0, "partido")} (idealmente 3-0). Con esto, ${nombreEquipoKey(equipoConsideradoKey)} sumar√≠a ${setsEquipoSiPierdeResto0a3} sets. Incluso si ${nombreEquipoKey(oponenteConsideradoKey)} gana los ${partidosRestantesPostVictoriasEquipo} ${pluralTxt(partidosRestantesPostVictoriasEquipo, "partido")} restantes por 3-0, solo alcanzar√≠a ${setsMaxOponenteSiGanaResto3a0} sets.`;
                    const escenarioActual = { tipo: 'sets', partidosAGanarIdealmente3a0: pGanadosEquipo3a0, setsAdicionalesEnDerrotas: 0, partidosDondeRascar: 0, detalleCorto: detalle };
                    if (escenarioOptimo === null || esMejorEscenario(escenarioActual, escenarioOptimo)) escenarioOptimo = escenarioActual;
                } else { // Caso B: Necesita sets adicionales
                    const setsNecesariosParaSuperar = (setsMaxOponenteSiGanaResto3a0 - setsEquipoSiPierdeResto0a3) + 1;
                    const maxSetsRascablesPorEquipoEnDerrotas = partidosRestantesPostVictoriasEquipo * 2;
                    if (setsNecesariosParaSuperar > 0 && setsNecesariosParaSuperar <= maxSetsRascablesPorEquipoEnDerrotas) {
                        const detalle = `Ganando ${pGanadosEquipo3a0} ${pluralTxt(pGanadosEquipo3a0, "partido")} (idealmente 3-0) Y ADEM√ÅS consiguiendo ${setsNecesariosParaSuperar} ${pluralTxt(setsNecesariosParaSuperar, "set")} en los ${partidosRestantesPostVictoriasEquipo} ${pluralTxt(partidosRestantesPostVictoriasEquipo, "partido")} restantes (que ser√≠an victorias del oponente, pero el equipo sumar√≠a estos sets, ej. perdiendo 2-3).`;
                        const escenarioActual = { tipo: 'sets', partidosAGanarIdealmente3a0: pGanadosEquipo3a0, setsAdicionalesEnDerrotas: setsNecesariosParaSuperar, partidosDondeRascar: partidosRestantesPostVictoriasEquipo, detalleCorto: detalle };
                        if (escenarioOptimo === null || esMejorEscenario(escenarioActual, escenarioOptimo)) escenarioOptimo = escenarioActual;
                    }
                }
            }

            // Escenario 2: Campe√≥n matem√°tico por PARTIDOS
            for (let pGanadosPorEquipo = 0; pGanadosPorEquipo <= partidosRestantesVuelta; pGanadosPorEquipo++) {
                const pFinalEquipo = statsEquipoActual.partidos + pGanadosPorEquipo;
                const pMaxFinalOponente = statsOponenteActual.partidos + (partidosRestantesVuelta - pGanadosPorEquipo);
                if (pFinalEquipo > pMaxFinalOponente) {
                    const detalle = `Ganando ${pGanadosPorEquipo} de los ${partidosRestantesVuelta} ${pluralTxt(partidosRestantesVuelta, "partido")} restantes. Con esto, se asegurar√≠an ${pFinalEquipo} ${pluralTxt(pFinalEquipo, "partido")} globales, superando el m√°ximo de ${pMaxFinalOponente} del oponente.`;
                    const escenarioActual = { tipo: 'partidos', partidosAGanarIdealmente3a0: pGanadosPorEquipo, setsAdicionalesEnDerrotas: 0, partidosDondeRascar: 0, detalleCorto: detalle };
                    if (escenarioOptimo === null || esMejorEscenario(escenarioActual, escenarioOptimo)) escenarioOptimo = escenarioActual;
                    break; 
                }
            }
            return escenarioOptimo;
        }

        function actualizarEscenarios() {
            const resultadosGlobales = calcularResultadosFinalGlobales();
            const partidosFinalizadosVuelta = Object.values(partidosVuelta).filter(p => p.finalizado).length;
            const partidosRestantesVuelta = ordenPartidos.length - partidosFinalizadosVuelta;
            let texto = `<h4><i class="fas fa-info-circle"></i> Situaci√≥n Actual General (Ida + Vuelta Parcial):</h4>`;
            texto += `<p><strong>${NOMBRE_IES_LA_ORDEN}:</strong> ${resultadosGlobales.recreativo.partidos}p, ${resultadosGlobales.recreativo.sets}s, ${resultadosGlobales.recreativo.puntos}pts</p>`;
            texto += `<p><strong>${NOMBRE_CARTAGENA}:</strong> ${resultadosGlobales.cartagena.partidos}p, ${resultadosGlobales.cartagena.sets}s, ${resultadosGlobales.cartagena.puntos}pts</p>`;
            texto += `<p><strong>Partidos restantes en la vuelta:</strong> ${partidosRestantesVuelta}</p><hr>`;
            
            const campeonDeterminadoUI = document.getElementById('championSection').classList.contains('show');
            const razonCampeonUI = document.getElementById('championDetails').textContent;

            if (campeonDeterminadoUI && (razonCampeonUI.toLowerCase().includes("matem√°ticamente") || partidosRestantesVuelta === 0)) {
                 texto += `<p><strong>El resultado del campeonato ya est√° determinado o es matem√°ticamente irreversible.</strong></p>`;
            } else if (partidosRestantesVuelta === 0 && !campeonDeterminadoUI){
                 texto += "<p>Todos los partidos de vuelta han finalizado. El resultado final deber√≠a estar determinado.</p>";
            }
             else {
                texto += `<h4><i class="fas fa-running"></i> V√≠a m√°s r√°pida para ser Campe√≥n Matem√°tico:</h4>`;
                ['recreativo', 'cartagena'].forEach(equipoKey => {
                    const nombreEquipoDisplay = nombreEquipoKey(equipoKey);
                    const escenarioRapido = calcularEscenarioCampeonMatematicoRapido(equipoKey, resultadosGlobales, partidosRestantesVuelta);
                    
                    texto += `<div class="scenario-item ${equipoKey === 'recreativo' ? 'recreativo' : ''}">`;
                    texto += `<h5><i class="fas fa-bullseye"></i> ${nombreEquipoDisplay}:</h5>`;
                    texto += `<div class="min-requirements ${equipoKey === 'recreativo' ? 'recreativo' : ''}">`;

                    if (escenarioRapido) {
                        texto += `<p>${escenarioRapido.detalleCorto}</p>`;
                    } else {
                        texto += `<p>No se ha encontrado una v√≠a clara para ser campe√≥n matem√°tico antes de la finalizaci√≥n de todos los partidos restantes. La definici√≥n probablemente llegar√° por los criterios de desempate generales al concluir todos los encuentros de vuelta.</p>`;
                         // Podr√≠amos a√±adir aqu√≠ la l√≥gica de desempate general si lo deseas, como estaba antes.
                         // Por ahora, lo dejamos m√°s simple si no hay escenario "r√°pido".
                    }
                    texto += '</div></div>';
                });
            }
            document.getElementById('scenarioText').innerHTML = texto;
        }

        function toggleScenarios() {
            const content = document.getElementById('scenarioContent');
            const icon = document.getElementById('scenarioIcon');
            const toggleButton = document.querySelector('.scenario-toggle');
            content.classList.toggle('show');
            if (content.classList.contains('show')) {
                icon.classList.remove('fa-chevron-down'); icon.classList.add('fa-chevron-up');
                toggleButton.classList.add('open');
            } else {
                icon.classList.remove('fa-chevron-up'); icon.classList.add('fa-chevron-down');
                toggleButton.classList.remove('open');
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('ida-rec-pg').textContent = resultadosIda.recreativo.partidos;
            document.getElementById('ida-rec-sg').textContent = resultadosIda.recreativo.sets;
            document.getElementById('ida-rec-ptg').textContent = resultadosIda.recreativo.puntos;
            document.getElementById('ida-car-pg').textContent = resultadosIda.cartagena.partidos;
            document.getElementById('ida-car-sg').textContent = resultadosIda.cartagena.sets;
            document.getElementById('ida-car-ptg').textContent = resultadosIda.cartagena.puntos;
            inicializarPartidosUI();
            actualizarResumenVuelta();
            actualizarResumenFinal();
            verificarCampeonMatematicoGlobal(); 
        });
    </script>
</body>
</html>
